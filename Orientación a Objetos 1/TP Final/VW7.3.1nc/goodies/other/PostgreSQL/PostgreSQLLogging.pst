<?xml version="1.0"?><st-source><!-- Name: PostgreSQLLoggingComment: ©Bruce Badger 2000 - 2004. Licensed under the LGPL.Primarily implelemented to support EXDI logging, this package can be used to capture detailed information about the message flowing between the PostgreSQL driver library and a PostgreSQL backend.Have a look at the class-side methods of the PostgreSQLLoggingTesting class.  Work though the test methods to get an idea of what you can do.- - Please send your comments to bbadger@openskills.com.  Thanks.DbIdentifier: OSSYD001DbTrace: 2209DevelopmentPrerequisites: #(#(#any 'PostgreSQLDriver' ''))HideSource: falsePackageName: PostgreSQLLoggingParcel: #('PostgreSQLLogging')PrerequisiteParcels: #(#('PostgreSQLDriver' '1.0 011'))PrintStringCache: (1.3 014,bbadger)SaveSource: trueVersion: 1.3 014Date: 8:03:19 pm November 4, 2004 --><time-stamp>From VisualWorks® NonCommercial, 7.2 of November 3, 2003 on November 4, 2004 at 8:03:19 pm</time-stamp><do-it>(Dialog confirm: 'You are filing-in a Parcel source file!\\While this is possible it will not have\the same effect as loading the parcel.\None of the Parcel''s prerequisites will\be loaded and none of its load actions\will be performed.\\Are you sure you want to file-in?' withCRs) ifFalse: [self error: 'Parcel file-in abandoned.  Choose terminate or close.']</do-it><class><name>PostgreSQLLoggingTesting</name><environment>Smalltalk</environment><super>Core.Object</super><private>false</private><indexed-type>none</indexed-type><inst-vars></inst-vars><class-inst-vars></class-inst-vars><imports></imports><category>Database-PostgreSQL-Logging</category><attributes><package>PostgreSQLLogging</package></attributes></class><class><name>PostgreSQLConnectionLog</name><environment>Smalltalk</environment><super>Core.Object</super><private>false</private><indexed-type>none</indexed-type><inst-vars>targetStream subjectConnections </inst-vars><class-inst-vars></class-inst-vars><imports></imports><category>Database-PostgreSQL-Logging</category><attributes><package>PostgreSQLLogging</package></attributes></class><class><name>PostgreSQLLoggingError</name><environment>Smalltalk</environment><super>NativeError</super><private>false</private><indexed-type>none</indexed-type><inst-vars></inst-vars><class-inst-vars></class-inst-vars><imports></imports><category>PostgreSQL-Logging</category><attributes><package>PostgreSQLLogging</package></attributes></class><methods><class-id>PostgreSQLLoggingTesting</class-id> <category>license</category><body package="PostgreSQLLogging">license	"^a License 	I return the license under which this software is made available."	^PostgreSQLDriverLicense license</body></methods><methods><class-id>PostgreSQLLoggingTesting class</class-id> <category>testing</category><body package="PostgreSQLLogging">test	"^self 	I run through all my tests. Before that I run the tests of the 	PostrgreSQL driver just to make sure all is well there."	"self test"	PostgreSQLTest test.	self test10.	self test11.	self test12.	self test20.	self test21.	^self</body><body package="PostgreSQLLogging">test10	"^self 	I use the logging facilities to capture the messages exchanged with 	the backend for a particular connection."	"self test10"	| connection logStream |	connection := PostgreSQLConnection using: self testParameterSet.	logStream := String new writeStream.	PostgreSQLConnectionLog logEverythingFor: connection to: logStream.	connection executeQuery: 'create table test04 (a int2, b int2)'.	connection executeQuery: 'insert into test04 values (1, 1)'.	connection executeQuery: 'select a, b from test04'.	connection executeQuery: 'drop table test04'.	connection close.	^logStream contents</body><body package="PostgreSQLLogging">test11	"^self 	I use the logging facilities to capture the messages exchanged with the backend for a particular 	connection. I close the logging half way through the queries, just to see if I can."	"self test11"	| connection logStream log |	connection := PostgreSQLConnection using: self testParameterSet.	logStream := String new writeStream.	log := PostgreSQLConnectionLog logEverythingFor: connection to: logStream.	connection executeQuery: 'create table test04 (a int2, b int2)'.	connection executeQuery: 'insert into test04 values (1, 1)'.	log close.	connection executeQuery: 'select a, b from test04'.	connection executeQuery: 'drop table test04'.	connection close.	^logStream contents</body><body package="PostgreSQLLogging">test12	"^self 	I use the logging facilities to capture the messages exchanged with the backend for a particular 	connection. I pause the logging for a while and then resume, just to see if I can."	"self test12"	| connection logStream log |	connection := PostgreSQLConnection using: self testParameterSet.	logStream := String new writeStream.	log := PostgreSQLConnectionLog logEverythingFor: connection to: logStream.	connection executeQuery: 'create table test04 (a int2, b int2)'.	log pause.	connection executeQuery: 'insert into test04 values (1, 1)'.	log resume.	connection executeQuery: 'select a, b from test04'.	connection executeQuery: 'drop table test04'.	connection close.	^logStream contents</body><body package="PostgreSQLLogging">test20	"^self 	I use the logging facilities to capture the messages exchanged with 	the backend for all connections. 	I set the logging and then run a test from PostgreSQLTest."	"self test20"	| logStream log |	logStream := String new writeStream.	log := PostgreSQLConnectionLog logEverythingTo: logStream.	PostgreSQLTest test05.	log close.	^logStream contents</body><body package="PostgreSQLLogging">test21	"^self 	I log a PostgreSQLTest which will use an unencrypted password. 	This tests the logging of the UnencryptedPasswordPacket."	"self test21"	| logStream log |	logStream := String new writeStream.	log := PostgreSQLConnectionLog logEverythingTo: logStream.	PostgreSQLTest test12.	log close.	^logStream contents</body><body package="PostgreSQLLogging">test22	"^self 	I log a PostgreSQLTest which will cause a notification to be raised.  This tests the logging of the NoticeResponseMessage."	"self test22"	| logStream log |	logStream := String new writeStream.	log := PostgreSQLConnectionLog logEverythingTo: logStream.	PostgreSQLTest test10.	log close.	^logStream contents</body></methods><methods><class-id>PostgreSQLLoggingTesting class</class-id> <category>support</category><body package="PostgreSQLLogging">testParameterSet	"^a ConnectionParameterSet 	I return the connection parameter set to be used for all my tests. I 	delegate this to PostgreSQLTest."	^PostgreSQLTest testParameterSet</body></methods><methods><class-id>PostgreSQLConnectionLog</class-id> <category>initialize-release</category><body package="PostgreSQLLogging">logEverythingFor: aConnection to: aStream 	"^self 	I initialize myself to log all communications with the backend for 	aConnection to aStream."	targetStream := aStream.	self startMonitoring: aConnection.	^self</body><body package="PostgreSQLLogging">logEverythingTo: aStream 	"^a PostgreSQLConnectionLog 	I initialize myself to log all communications with the backend for 	*all* (existing &amp; new) connections to aStream."	targetStream := aStream.	PostgreSQLConnection commonLog: self.	^self</body></methods><methods><class-id>PostgreSQLConnectionLog</class-id> <category>private</category><body package="PostgreSQLLogging">closeTargetStream	"^self 	I close the target stream (if it understand that - e.g. the Transcript 	does not) and set my instance variable to nil."	(self targetStream respondsTo: #close) ifTrue: [self targetStream close].	targetStream := nil.	^self</body><body package="PostgreSQLLogging">loggingBlock	"^a BlockClosure 	I return the block I use to replace the default block in a connection. 	My block delegates the job of logging to my &gt;&gt;logMessage: method."	^[:aMessage | self logMessage: aMessage]</body></methods><methods><class-id>PostgreSQLConnectionLog</class-id> <category>services</category><body package="PostgreSQLLogging">close	"^self 	I close myself. This means I remove my logging blocks from my 	target connection(s) and close the 	target stream. Once closed, I can not be re-started. Use &gt;&gt;pause 	instead if you want to be able to 	re-start logging with me. I check to see if I'm the common log for all 	connections &amp; if I am, I remove myself."	self subjectConnections do: [:aConnection | self stopMonitoring: aConnection].	PostgreSQLConnection commonLog == self ifTrue: [PostgreSQLConnection commonLog: nil].	self closeTargetStream.	^self</body><body package="PostgreSQLLogging">logMessage: aMessage 	"^self 	I log aMessage to my target stream. I write out a timestamp, 	followed by a representation of aMessage. Lastly I flush the stream."	(self targetStream) cr; nextPutAll: Timestamp now printString; cr.	aMessage printOn: self targetStream.	self targetStream flush.	^self</body><body package="PostgreSQLLogging">pause	"^self 	I stop logging my connections. I keep the logging stream open, so I am able to continue logging if 	I'm sent &gt;&gt;resume."	self subjectConnections do: [:aConnection | self stopMonitoring: aConnection].	^self</body><body package="PostgreSQLLogging">resume	"^self 	I resume logging my connections. I can only resume if the logging stream is still open (the state I 	would expect after a pause)."	targetStream isNil ifTrue: [PostgreSQLLoggingError raiseSignal: 'Attempt to resume a log when the log stream is close.'].	self subjectConnections do: [:aConnection | self startMonitoring: aConnection].	^self</body><body package="PostgreSQLLogging">startMonitoring: aConnection 	"^self 	I add aConnection to my collection of monitored connections, and I replace the current logging block 	of aConnection with my logging blocks.."	self subjectConnections add: aConnection.	aConnection readStream loggingBlock: self loggingBlock.	aConnection writeStream loggingBlock: self loggingBlock.	^self</body><body package="PostgreSQLLogging">stopMonitoring: aConnection 	"^self 	I reset the logging blocks of a connection so they no longer use mine. I make sure that aConnection 	is in my collection of subjectConnections before I fiddle with the logging blocks of aConnection. If a 	Connection is not one of my subjectConnections, I simply return myself."	(self subjectConnections includes: aConnection)		ifTrue: 			[aConnection readStream loggingBlock: nil.			aConnection writeStream loggingBlock: nil].	^self</body></methods><methods><class-id>PostgreSQLConnectionLog</class-id> <category>accessing</category><body package="PostgreSQLLogging">subjectConnections	"^a Set 	I return a set containing the connections I'm currently logging the traffic of."	subjectConnections isNil ifTrue: [subjectConnections := Set new].	^subjectConnections</body><body package="PostgreSQLLogging">targetStream	"^a Stream like thing 	I return the stream (or Transcript, or whatever) that I've been asked 	to log to."	^targetStream</body></methods><methods><class-id>PostgreSQLConnectionLog class</class-id> <category>instance creation</category><body package="PostgreSQLLogging">logEverythingFor: aConnection to: aStream 	"^a PostgreSQLConnectionLog 	I return an instance of myself which logs all communications with 	the backend to aStream."	^self new logEverythingFor: aConnection to: aStream</body><body package="PostgreSQLLogging">logEverythingTo: aStream 	"^a PostgreSQLConnectionLog 	I return an instance of myself which logs all communications with 	the backend for *all* (exiting &amp; new) connections to aStream."	^self new logEverythingTo: aStream</body></methods><do-it>"Imported Classes:"</do-it><do-it>self error: 'Attempting to file-in parcel imports.  Choose terminate or close'</do-it><class><name>Object</name><environment>Core</environment><super></super><private>false</private><indexed-type>none</indexed-type><inst-vars></inst-vars><class-inst-vars></class-inst-vars><imports></imports><category>Kernel-Objects</category><attributes><package>Kernel-Objects</package></attributes></class><class><name>NativeError</name><environment>Smalltalk</environment><super>Core.Error</super><private>false</private><indexed-type>none</indexed-type><inst-vars></inst-vars><class-inst-vars></class-inst-vars><imports></imports><category>PostgreSQLVWCompatibility</category><attributes><package>PostgreSQLVWCompatibility</package></attributes></class></st-source>